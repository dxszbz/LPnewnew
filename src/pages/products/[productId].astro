---
import { listAvailableProducts, listProductLocales } from '../../utils/loadProduct';
import { siteConfig } from '../../config';

export const getStaticPaths = () => {
  const products = listAvailableProducts();
  return products.map((productId) => ({
    params: { productId },
    props: {
      locales: listProductLocales(productId),
      defaultLocale: siteConfig.locales.default
    }
  }));
};

const { productId } = Astro.params;
const { locales = [], defaultLocale } = Astro.props as { locales?: string[]; defaultLocale?: string };
const availableProducts = listAvailableProducts();

if (!productId || !availableProducts.includes(productId)) {
  throw new Error(`找不到產品 ${productId}，請確認資料夾是否存在。`);
}

// 使用瀏覽器首選語言挑選最佳 locale，直接在客端 replace，避免 Astro redirect 中間頁
const availableLocales = locales;
const siteDefault = siteConfig.locales.default;

const runtimeConfig = {
  productId,
  availableLocales,
  defaultLocale: siteDefault,
  fallbackLocale: locales[0] ?? defaultLocale ?? siteDefault
};
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script
      is:inline
      set:html={`(function(){try{
        var cfg=${JSON.stringify(runtimeConfig)};
        var locales=cfg.availableLocales||[];
        if(!Array.isArray(locales)||!locales.length){locales=[cfg.defaultLocale||'en'];}
        var normalize=function(l){return (l||'').toLowerCase().split('-')[0];};
        var pick=function(){
          var nav=typeof navigator!=='undefined'?navigator:null;
          var prefs=(nav&&nav.languages&&nav.languages.length)?nav.languages:(nav&&nav.language?[nav.language]:[]);
          for(var i=0;i<prefs.length;i++){
            var base=normalize(prefs[i]);
            var hit=locales.find(function(loc){return normalize(loc)===base;});
            if(hit) return hit;
          }
          var defHit=locales.find(function(loc){return loc===cfg.defaultLocale;});
          if(defHit) return defHit;
          return locales[0]||cfg.fallbackLocale||cfg.defaultLocale||'en';
        };
        var targetLocale=pick();
        var search=typeof window!=='undefined'?window.location.search:'';
        var hash=typeof window!=='undefined'?window.location.hash:'';
        var target='/products/'+cfg.productId+'/'+targetLocale+search+hash;
        if(typeof window!=='undefined' && window.location.pathname+search+hash!==target){
          window.location.replace(target);
        }
      }catch(e){console.error('locale redirect failed',e);}})();`}
    ></script>
    <noscript>
      <meta http-equiv="refresh" content={`0;url=/products/${runtimeConfig.productId}/${runtimeConfig.fallbackLocale}`} />
    </noscript>
  </head>
  <body></body>
</html>
---
