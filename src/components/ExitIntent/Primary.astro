---
import { formatCurrency } from '../../utils/format';
import type { ExitIntentContent, ProductData } from '../../utils/types';

interface Props {
  product: ProductData;
  content: ExitIntentContent;
}

const { product, content } = Astro.props;
const headingId = `exit-intent-title-${product.sku}`;
const descriptionId = `exit-intent-description-${product.sku}`;
const primaryHref = content.ctaHref?.trim() || '#purchase';
const secondaryHref = content.secondaryCtaHref?.trim() || '#purchase';
const priceLabel = content.ctaLabel?.includes('{{price}}')
  ? formatCurrency(product.price.current, product.price.currency)
  : null;
const primaryLabel = priceLabel ? content.ctaLabel.replace('{{price}}', priceLabel) : content.ctaLabel;
---

{content?.enabled && (
  <div
    class="exit-intent pointer-events-none fixed inset-0 z-50 hidden flex items-center justify-center px-4 py-6 opacity-0 transition-opacity duration-300 ease-out data-[state=open]:pointer-events-auto data-[state=open]:opacity-100 sm:px-6"
    data-exit-intent-root
    data-state="closed"
    aria-hidden="true"
  >
    <div
      class="absolute inset-0 bg-slate-950/70 opacity-0 transition-opacity duration-300 ease-out data-[state=open]:opacity-100 backdrop-blur-sm"
      data-exit-backdrop
      data-state="closed"
      data-exit-dismiss
    ></div>
    <article
      class="relative z-10 flex w-full max-w-4xl flex-col overflow-hidden rounded-3xl border border-slate-200 bg-white text-slate-900 shadow-[0_25px_80px_rgba(15,23,42,0.25)] opacity-0 translate-y-4 scale-95 transform-gpu transition-all duration-300 ease-out data-[state=open]:translate-y-0 data-[state=open]:scale-100 data-[state=open]:opacity-100 dark:border-white/10 dark:bg-slate-900/95 dark:text-white dark:shadow-[0_25px_80px_rgba(2,6,23,0.8)]"
      role="dialog"
      aria-modal="true"
      aria-labelledby={headingId}
      aria-describedby={descriptionId}
      data-exit-dialog
      data-state="closed"
      tabindex="-1"
    >
      <button
        type="button"
        class="absolute right-4 top-4 inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white text-slate-700 transition hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-400 dark:border-white/20 dark:bg-white/5 dark:text-white/80 dark:hover:bg-white/10"
        aria-label={content.dismissLabel}
        data-exit-dismiss
      >
        <i data-lucide="x" class="h-5 w-5"></i>
      </button>

      <div class="grid gap-6 p-6 sm:p-10 lg:grid-cols-[1.15fr_0.85fr]">
        <div class="flex flex-col gap-4">
          {content.badge && (
            <span class="inline-flex w-fit items-center gap-2 rounded-full border border-brand-400/50 bg-brand-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-brand-700 dark:text-brand-100">
              <i data-lucide="sparkles" class="h-3.5 w-3.5 text-brand-700 dark:text-brand-100"></i>
              {content.badge}
            </span>
          )}
          <div class="space-y-3">
            <h3 id={headingId} class="text-2xl font-black leading-snug text-slate-900 dark:text-white sm:text-3xl">
              {content.title}
            </h3>
            <p id={descriptionId} class="text-base text-slate-700 dark:text-white/70 sm:text-lg">
              {content.description}
            </p>
            {content.highlight && <p class="text-sm font-semibold text-brand-700 dark:text-brand-50">{content.highlight}</p>}
          </div>
          {content.bullets && content.bullets.length > 0 && (
            <ul class="mt-2 space-y-2 text-sm text-slate-700 dark:text-white/85">
              {content.bullets.map((item) => (
                <li class="flex items-start gap-3">
                  <span class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-full bg-brand-500/10 text-brand-700 dark:bg-brand-500/15 dark:text-brand-50">
                    <i data-lucide="check" class="h-3.5 w-3.5"></i>
                  </span>
                  <span>{item}</span>
                </li>
              ))}
            </ul>
          )}
          <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center">
            <a
              href={primaryHref}
              class="inline-flex flex-1 items-center justify-center rounded-full bg-brand-500 px-6 py-3 text-base font-black text-slate-950 transition hover:bg-brand-400 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-300"
              data-exit-primary
            >
              {primaryLabel}
            </a>
            {content.secondaryCtaLabel && (
              <a
                href={secondaryHref}
                class="inline-flex flex-1 items-center justify-center rounded-full border border-slate-200 px-6 py-3 text-base font-semibold text-slate-700 transition hover:bg-slate-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-300 dark:border-white/30 dark:text-white/80 dark:hover:bg-white/10"
                data-exit-dismiss
              >
                {content.secondaryCtaLabel}
              </a>
            )}
          </div>
        </div>
        {content.image && (
          <div class="relative hidden overflow-hidden rounded-2xl border border-slate-200 bg-slate-100 shadow-sm dark:border-white/10 dark:bg-slate-950/60 md:block">
            <img
              src={content.image.url}
              alt={content.image.alt}
              class="h-full w-full object-cover"
              loading="lazy"
            />
            <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-100/60 to-transparent dark:from-slate-950/70"></div>
          </div>
        )}
      </div>
    </article>
  </div>
)}
