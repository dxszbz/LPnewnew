---
export interface Props {
  productName: string;
}

const { productName } = Astro.props satisfies Props;
---

<header class="relative z-40 border-b border-slate-200/80 bg-white/90 text-slate-900 backdrop-blur-sm dark:border-slate-800/50 dark:bg-slate-950/80 dark:text-white">
  <div class="mx-auto flex w-full max-w-screen-xl items-center justify-between px-4 py-3 sm:px-6 lg:px-10">
    <!-- Logo -->
    <div class="flex items-center">
      <span class="text-lg font-bold text-slate-900 hover:text-primary-500 transition-colors dark:text-white dark:hover:text-primary-400">
        {productName}
      </span>
    </div>

    <!-- Controls -->
    <div class="flex items-center gap-2">
      <!-- Theme Toggle -->
      <button
        id="theme-toggle"
        type="button"
        aria-label="Toggle theme"
        class="rounded-lg p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-900 transition-colors dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white"
      >
        <i data-lucide="sun" class="h-5 w-5 hidden [[data-theme-mode='day']_&]:block" aria-hidden="true"></i>
        <i data-lucide="moon" class="h-5 w-5 hidden [[data-theme-mode='night']_&]:block" aria-hidden="true"></i>
        <i data-lucide="monitor" class="h-5 w-5 hidden [[data-theme-mode='system']_&]:block" aria-hidden="true"></i>
      </button>

      <!-- Language Switcher -->
      <div class="relative">
        <button
        id="locale-toggle"
        type="button"
        aria-label="Select language"
        aria-haspopup="true"
        aria-expanded="false"
        class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 hover:text-slate-900 transition-colors dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white"
      >
        <span id="current-locale" class="flex items-center gap-1.5"></span>
        <i data-lucide="chevron-down" class="h-3 w-3" aria-hidden="true"></i>
      </button>

        <!-- Dropdown Menu -->
        <div
          id="locale-menu"
          class="absolute right-0 mt-2 w-32 origin-top-right rounded-lg border border-slate-200 bg-white py-1 shadow-xl opacity-0 scale-95 pointer-events-none transition-all duration-200 dark:border-slate-700 dark:bg-slate-900"
          role="menu"
          aria-orientation="vertical"
          aria-labelledby="locale-toggle"
        >
          <!-- Language options will be populated by JS -->
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  import { refreshIcons } from '../../scripts/utils/icons';

  // 中文註解：初始化頭部互動功能
  function initHeader() {
    const getRuntime = () => {
      const host = document.getElementById('landing-runtime') as HTMLScriptElement | null;
      if (!host?.textContent) return null;
      try {
        return JSON.parse(host.textContent) as {
          product?: { sku?: string };
          locale?: string;
        };
      } catch {
        return null;
      }
    };
    const runtime = getRuntime();

    type ThemeApi = {
      getTheme: () => string;
      setTheme: (nextTheme: string) => void;
      listThemes: () => string[];
    };

    type I18nApi = {
      getLocale: () => string;
      setLocale: (locale: string) => void;
      listLocales: () => string[];
    };

    const themeToggle = document.getElementById('theme-toggle');
    const localeToggle = document.getElementById('locale-toggle');
    const localeMenu = document.getElementById('locale-menu');
    const currentLocaleEl = document.getElementById('current-locale');

    if (!themeToggle || !localeToggle || !localeMenu || !currentLocaleEl) return;

    // 主題切換邏輯
    const themeApi = (window as typeof window & { __LANDER_THEME__?: ThemeApi }).__LANDER_THEME__;
    const availableThemes = themeApi?.listThemes() ?? ['system', 'day', 'night'];

    themeToggle.addEventListener('click', (ev) => {
      if (!themeApi) return;
      // 避免影響其他點擊監聽（如語言選單）
      ev.stopPropagation();
      const current = themeApi.getTheme();
      const currentIndex = availableThemes.indexOf(current as any);
      const nextIndex = (currentIndex + 1) % availableThemes.length;
      const nextTheme = availableThemes[nextIndex];
      themeApi.setTheme(nextTheme);
    });

    // 語言切換邏輯
    const i18nApi = (window as typeof window & { __LANDER_I18N__?: I18nApi }).__LANDER_I18N__;
    const localesFromApi = i18nApi?.listLocales() ?? ['en'];
    // 確保 supportedLocales 是陣列而不是字串
    const supportedLocales = Array.isArray(localesFromApi) ? localesFromApi : Array.from(localesFromApi);
    const runtimeLocale = runtime?.locale?.toLowerCase();

    // 取得國旗代碼：未匹配時回退至美國
    const localeToCountry = (locale: string) => {
      const raw = (locale || '').toLowerCase();
      const base = raw.split('-')[0];
      const map: Record<string, string> = {
        en: 'us',
        fr: 'fr',
        es: 'es',
        de: 'de',
        it: 'it',
        nl: 'nl',
        pt: 'pt',
        'pt-br': 'br',
        zh: 'cn',
        ja: 'jp',
        ko: 'kr',
        ar: 'sa',
        ru: 'ru'
      };
      return map[raw] ?? map[base] ?? 'us';
    };

    const renderFlag = (locale: string) => {
      const country = localeToCountry(locale);
      return `<span class="fi fi-${country} h-4 w-6 rounded-sm shadow-sm shrink-0"></span>`;
    };

    // 更新當前語言顯示
    const updateCurrentLocale = () => {
      if (!i18nApi) return;
      const current = i18nApi.getLocale();
      currentLocaleEl.innerHTML = `${renderFlag(current)}<span class="sr-only">${current.toUpperCase()}</span>`;
    };

    // 確保當前頁的 locale 強制覆蓋本地存儲的舊值，避免顯示錯誤國旗
    if (
      i18nApi &&
      runtimeLocale &&
      supportedLocales.includes(runtimeLocale) &&
      i18nApi.getLocale() !== runtimeLocale
    ) {
      i18nApi.setLocale(runtimeLocale);
    }

    // 填充語言選單
    const populateLocaleMenu = () => {
      if (!localeMenu || !i18nApi) return;

      const currentLocale = i18nApi.getLocale();
      localeMenu.innerHTML = supportedLocales
        .map(locale => {
          const isActive = locale === currentLocale;
          return `
            <button
              type="button"
              class="flex w-full items-center gap-2 px-4 py-2 text-sm text-left ${
                isActive
                  ? 'bg-primary-50 text-primary-700 dark:bg-primary-500/10 dark:text-primary-400'
                  : 'text-slate-700 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-white'
              } transition-colors"
              data-locale="${locale}"
              role="menuitem"
            >
              ${isActive ? '<i data-lucide="check" class="h-3 w-3" aria-hidden="true"></i>' : '<span class="w-3"></span>'}
              <span class="flex items-center gap-2">
                ${renderFlag(locale)}
                <span class="uppercase">${locale}</span>
              </span>
            </button>
          `;
        })
        .join('');

      // 重新初始化 Lucide 圖標
      refreshIcons();

      // 綁定點擊事件
      localeMenu.querySelectorAll('[data-locale]').forEach(button => {
        button.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const locale = target.dataset.locale;
          if (locale && i18nApi) {
            i18nApi.setLocale(locale);
            updateCurrentLocale();
            populateLocaleMenu();
            toggleLocaleMenu(false);
            const productId = runtime?.product?.sku;
            if (productId) {
              const segments = window.location.pathname.split('/').filter(Boolean);
              const productIndex = segments.findIndex((seg) => seg === productId);
              let nextPath = window.location.pathname;
              if (productIndex !== -1) {
                if (segments[productIndex + 1]) {
                  segments[productIndex + 1] = locale;
                } else {
                  segments.splice(productIndex + 1, 0, locale);
                }
                nextPath = `/${segments.join('/')}`;
              } else {
                nextPath = `/products/${productId}/${locale}`;
              }
              const url = new URL(nextPath + window.location.search + window.location.hash, window.location.origin);
              window.location.href = url.toString();
            }
          }
        });
      });
    };

    // 切換選單顯示
    const toggleLocaleMenu = (show?: boolean) => {
      const isOpen = localeMenu.classList.contains('opacity-100');
      const shouldOpen = show ?? !isOpen;

      if (shouldOpen) {
        localeMenu.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        localeMenu.classList.add('opacity-100', 'scale-100');
        localeToggle.setAttribute('aria-expanded', 'true');
      } else {
        localeMenu.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
        localeMenu.classList.remove('opacity-100', 'scale-100');
        localeToggle.setAttribute('aria-expanded', 'false');
      }
    };

    // 點擊語言按鈕切換選單
    localeToggle.addEventListener('click', (event) => {
      event.stopPropagation();
      toggleLocaleMenu();
    });

    // 點擊外部關閉選單
    document.addEventListener('click', (e) => {
      const target = e.target as Node;
      if (!localeToggle.contains(target) && !localeMenu.contains(target)) {
        toggleLocaleMenu(false);
      }
    });

    // 初始化
    updateCurrentLocale();
    populateLocaleMenu();

    // 監聽語言變更事件
    document.addEventListener('lander:locale-change', () => {
      updateCurrentLocale();
      populateLocaleMenu();
    });
  }

  // 初始化並在需要時重新初始化圖標
  initHeader();
  refreshIcons();
</script>
