---
import { formatCurrency, encodeMetaPayload } from '../../utils/format';
import type { ProductData, PurchaseContent } from '../../utils/types';
import { LAZY_MEDIA_PLACEHOLDER } from '../../utils/lazyMedia';

export interface Props {
  product: ProductData;
  content: PurchaseContent;
}

const { product, content } = Astro.props satisfies Props;
const priceLabel = formatCurrency(product.price.current, product.price.currency);
const metaPayload = encodeMetaPayload(product.meta);
const buttonLabel = content.ctaLabel.replace('{{price}}', priceLabel);
const checkoutType = product.checkout.type;
const directCheckoutURL = checkoutType === 'direct' ? product.checkout.url.trim() : '';
const hasDirectCheckout = checkoutType === 'direct' && Boolean(directCheckoutURL);
const ctaClasses =
  'group flex w-full items-center justify-center gap-2 rounded-full bg-brand-500 px-6 py-4 text-lg font-black text-white shadow-glow transition hover:bg-brand-600 focus:outline-none focus:ring-4 focus:ring-brand-500/60';
---

<section id="purchase" class="mt-16 scroll-mt-24 rounded-3xl border border-slate-200 bg-slate-50 p-6 dark:border-white/5 dark:bg-slate-900/50 sm:p-10">
  <h2 class="text-3xl font-bold text-slate-900 dark:text-white">{content.title}</h2>
  <div class="mt-6 grid gap-6 sm:grid-cols-2">
    <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-white/10 dark:bg-slate-950/60">
      <img
        class="lazyload h-full w-full object-cover"
        src={LAZY_MEDIA_PLACEHOLDER}
        data-src={product.mainImage.url}
        alt={content.mediaAlt}
      />
      <noscript>
        <img class="h-full w-full object-cover" src={product.mainImage.url} alt={content.mediaAlt} />
      </noscript>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm dark:border-white/10 dark:bg-slate-950/60">
      <p class="text-xl font-bold text-slate-900 dark:text-white">{product.name}</p>
      <p class="mt-1 text-sm text-slate-600 dark:text-white/60">{content.subtitle}</p>
      <div class="mt-6 space-y-4">
        {hasDirectCheckout ? (
          <a href={directCheckoutURL} class={ctaClasses} rel="noreferrer">
            <span>{buttonLabel}</span>
            <i data-lucide="arrow-right" class="checkout-icon h-5 w-5 transition-transform group-hover:translate-x-1"></i>
          </a>
        ) : (
          <form
            id="purchase-form"
            class="space-y-4"
            action="#"
            method="post"
            data-checkout-sku={product.sku}
            data-checkout-price={product.price.current}
            data-checkout-currency={product.price.currency}
            data-checkout-meta={metaPayload}
            data-image-url={product.mainImage.url}
          >
            <div class="flex items-center gap-3">
              <span class="text-sm text-slate-700 dark:text-white/70">{content.quantityLabel}</span>
              <div class="inline-flex items-center overflow-hidden rounded-full border border-slate-300 bg-white dark:border-white/20 dark:bg-transparent">
                <button type="button" id="qty-dec" class="px-3 py-2 text-slate-700 hover:bg-slate-100 dark:text-white/80 dark:hover:bg-white/10" aria-label="Decrease quantity">−</button>
                <input id="purchase-qty" class="w-12 bg-transparent text-center text-slate-900 dark:text-white" type="number" name="quantity" value="1" min="1" max="99">
                <button type="button" id="qty-inc" class="px-3 py-2 text-slate-700 hover:bg-slate-100 dark:text-white/80 dark:hover:bg-white/10" aria-label="Increase quantity">＋</button>
              </div>
            </div>
            <button type="submit" data-checkout-trigger class={ctaClasses}>
              <span data-checkout-cta-text>{buttonLabel}</span>
              <i data-checkout-cta-icon data-lucide="arrow-right" class="checkout-icon h-5 w-5 transition-transform group-hover:translate-x-1"></i>
            </button>
          </form>
        )}
        <div class="mt-4 grid grid-cols-2 gap-2 text-xs text-slate-700 dark:text-white/80 sm:grid-cols-3" aria-label="Checkout assurances">
          {content.assurances.map((item) => (
            <div class="flex items-center gap-2 rounded-lg bg-slate-100 px-3 py-2 ring-1 ring-slate-200 dark:bg-slate-900/60 dark:ring-white/10">
              <i data-lucide={item.icon} class="h-4 w-4 text-brand-600 dark:text-brand-100"></i>
              <span>{item.text}</span>
            </div>
          ))}
        </div>
      </div>
      <p class="mt-2 text-center text-xs text-slate-600 dark:text-white/60">{content.note}</p>
    </div>
  </div>
</section>
